<!DOCTYPE html>

<html lang = "en">
   
<head>
	<title>Example usage of PyForumAPI</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0,  minimum-scale=1.0"> 
	<meta charset='utf-8' />
	<link rel="stylesheet" href="example.css" />
	<script src="pyforum.js"></script>
	<script src="https://apis.google.com/js/platform.js" async defer></script>
	<meta name="google-signin-client_id" content="397944035490-1ojdlm58ess32m3iigdck8gugopmvng1.apps.googleusercontent.com">
</head>
  
<body>
	<div id="wrapper">
		<div id="dimmer"></div> <!-- Semi transparent layer used to dim the page and direct attention to the pop-up forms -->
		<div id="header">
			<forumtitle>Kentas forum för alldagliga ting</forumtitle>
			<button id="signInButton" onclick="signIn();">Sign In</button>
			<button id="signOutButton" onclick="signOut();">Sign out</button>
		</div>
		<div id="output"></div> <!-- Area for thread or post list -->
		<div id="createButtonSpace"></div> <!-- Area for buttons -->
		<div id="signInBox"> <!-- Area for google sign in button -->
			<div class="g-signin2" data-onsuccess="onSignIn"></div>
		</div>
		<div id="newPostBox">   <!-- Pop-up form for making a new post -->
			<div class="cancelButton" onclick="closePopUps()">&#x2716</div>
			<textarea           id="postText"     placeholder="Skriv ditt inlägg här" ></textarea>
			<button onclick='addPost()'>Lägg Till Inlägg</button>
		</div>
		<div id="newThreadBox"> <!-- Pop-up form for making a new thread -->
			<div class="cancelButton" onclick="closePopUps()">&#x2716</div>
			<input  type="text" id="threadTitle"   placeholder="Namn på tråden" ><br>
			<textarea           id="threadText"    placeholder="Trådens ämne" ></textarea><br>
			<button onclick='addThread()'>Lägg Till Tråd</button>
		</div>
	</div>
</body>

<script>

	// Variable for user's token, used to indentiy the user server side
	id_token=0;

	// Micro jquery!!!
	function $(ele){
		return document.getElementById(ele);
	}

	// Create a forum object
	myForum = new PyForum('wu16');
	
	function signIn(){
		// "Dims" the whole page by making the dimmer div visible
		$('dimmer').style.display='block';
		$('signInBox').style.display='flex';
	}
	
	function onSignIn(googleUser) {
		id_token = googleUser.getAuthResponse().id_token;
	//	var xhr = new XMLHttpRequest();
	//	var para  = {};
	//	para['task']    = "logIn";
	//	para['idtoken'] = id_token;
	//	xhr.open('POST', 'http://nile16.nu:1201/', true); // should be https but raspberry no support yet
	//	xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
	//	xhr.onload = function() {
	//		console.log('Signed in as: ' + xhr.responseText);
	//	};
	//	xhr.send(JSON.stringify(para));
	//	console.log("token sent: ",para);
		document.getElementById('signInButton').style.display='none';
		document.getElementById('signOutButton').style.display='block';
		document.getElementById('signInBox').style.display='none';
		document.getElementById('dimmer').style.display='none';
		document.getElementById('createButtonSpace').style.display='block';
	}
	
	
	function signOut() {
		var auth2 = gapi.auth2.getAuthInstance();
		auth2.signOut().then(function () {
		console.log('User signed out.');
		});
		document.getElementById('signInButton').style.display='block';
		document.getElementById('signOutButton').style.display='none';
		document.getElementById('createButtonSpace').style.display='none';
	}

	
	
	// Writes a list of threads to the output div
	function writeThreadList(threadlist){
		// Add a button for creation of a new thread
		$('createButtonSpace').innerHTML="<button onclick='showNewThreadPopUp()'>Skapa Tråd</button>";
		// Clear 
		$('output').innerHTML="";
		// Loop through the thread list line by line and write links to threads in output div 
		for (i=0;i<threadlist.length;i++) {
			$('output').innerHTML+="<b><a href='#' onclick='myForum.getThread(\""+threadlist[i]['_id']+"\",writeThread)' >"+threadlist[i]['title']+"</a></b><br>";
			$('output').innerHTML+="<small>"+threadlist[i]['replys']+" Replies &#x2022 "+threadlist[i]['viewed']+" Views &#x2022 ";
			d = new Date(threadlist[i]['time']*1000);
			$('output').innerHTML+="<small>Created: <i><b>"+threadlist[i]['creator']+"</b></i> "+d.toLocaleDateString()+" "+d.toLocaleTimeString();
			d = new Date(threadlist[i]['last_time']*1000);
			if (threadlist[i]['last']!="") $('output').innerHTML+="<small> &#x2022 Last Post: <i><b>"+threadlist[i]['last']+"</b></i> "+d.toLocaleDateString()+"  "+d.toLocaleTimeString()+"</small>";
			$('output').innerHTML+="<br>";
		}
	}
	
	// Writes a thread with posts to the output div
	function writeThread(thread){
		// Replace any text in the output div with a button used to return to the thread list view
		$('output').innerHTML="<div class='cancelButton' onclick='myForum.getThreadList(writeThreadList)'>&#x2716</div>";
		// Add thread title, text and author name to the output div
		$('output').innerHTML+="<b><headline>"+thread['title']+"</headline></b><p>"+thread['text']+"</p>Startad av: <i>"+thread['creator']+"</i><br><hr>";
		// Loop through the list of posts write the posts one by one to the output div
		for (i=0;i<thread['posts'].length;i++) {
			$('output').innerHTML+="<p>"+thread['posts'][i]['text']+"</p><i>"+thread['posts'][i]['author']+"</i><hr>";
		}
		// Add a button for creation of a new post 
		$('createButtonSpace').innerHTML="<button onclick='showNewPostPopUp()'>Skriv Inlägg</button>";
	}

	function showNewPostPopUp(){
		// "Dims" the whole page by making the dimmer div visible
		$('dimmer').style.display='block';
		// Removes any remaining text from last post
		$('postText').value="";
		// Make the post dialoge visible
		$('newPostBox').style.display='block';
	}

	function showNewThreadPopUp(){
		// "Dims" the whole page by making the dimmer div visible
		$('dimmer').style.display='block';
		// Removes any remaining title and text from last post
		$('threadTitle').value="";
		$('threadText').value="";
		// Make the new thread dialoge visible
		$('newThreadBox').style.display='block';
	}

	function addThread(){
		// Order the creation of a new thread using PyForumAPI's addThread method
		myForum.addThread($('threadTitle').value,$('threadText').value);
		// close pop-up form
		closePopUps();
		// Order an updated list of threads to be sent to writeThreadList function (for output on screen) using PyForumAPI's getThreadList method 
		myForum.getThreadList(writeThreadList);
	}
	
	function addPost(){
		// Order the creation of a new post using PyForum API
		myForum.addPost($('postText').value);
		// close pop-up form
		closePopUps();
		// Order an updated list of posts to be sent to writeThread function (for output on screen) using PyForumAPI's getThread method 
		myForum.getThread('last',writeThread);
	}

	function closePopUps(){
		// Hide the new thread dialoge
		$('newThreadBox').style.display='none';
		// Hide the new post dialoge
		$('newPostBox').style.display='none';
		// Hide the dimmer
		$('dimmer').style.display='none';
	}
	
	// When the page loads, order a list of threads to be sent to writeThreadList function (for output on screen) using PyForumAPI's getThreadList method
	myForum.getThreadList(writeThreadList);

	
</script>
</html>